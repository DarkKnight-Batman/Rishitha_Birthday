<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Holi Bash 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&family=Pacifico&display=swap" rel="stylesheet">
    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; overflow: hidden; background: #fdfdfd; user-select: none; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; cursor: crosshair; }
        
        /* --- FESTIVE HOLI LOGIN PAGE --- */
        #login-overlay { 
            position: fixed; inset: 0; z-index: 100; 
            display: flex; align-items: center; justify-content: center; 
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            overflow: hidden;
        }

        /* Moving Holi Clouds */
        .holi-bg-blob {
            position: absolute; width: 500px; height: 500px; border-radius: 50%;
            filter: blur(100px); opacity: 0.5; z-index: 0;
            animation: floatBlob 25s infinite alternate ease-in-out;
        }
        @keyframes floatBlob {
            0% { transform: translate(-20%, -20%) scale(1); }
            100% { transform: translate(30%, 40%) scale(1.3); }
        }

        /* Floating Holi Icons (Pichkaris, Buckets, Gulaal) */
        .floating-icon {
            position: absolute; font-size: 3.5rem; opacity: 0.25; pointer-events: none;
            animation: floatIcon 12s infinite linear;
            z-index: 5;
        }
        @keyframes floatIcon {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-20vh) rotate(360deg); opacity: 0; }
        }

        .login-card {
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            z-index: 20; position: relative;
            box-shadow: 0 40px 80px rgba(0,0,0,0.4);
            transition: all 0.5s ease;
        }

        #admin-overlay { position: fixed; inset: 0; z-index: 110; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); }
        
        .ui-layer { position: relative; z-index: 10; pointer-events: none; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; }
        .interactive { pointer-events: auto; }
        
        .gradient-text { 
            background: linear-gradient(to right, #ff0055, #ffdd00, #00ffaa, #0088ff, #cc00ff); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            background-size: 400% 400%; animation: moveGradient 5s ease infinite; 
        }
        @keyframes moveGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; cursor: pointer; transition: all 0.2s; }
        .active-color { border: 3px solid #000; transform: scale(1.25); }
        
        .wish-popup { 
            position: fixed; pointer-events: none; font-weight: 900; padding: 12px 24px; 
            background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            z-index: 5; animation: floatUp 4.5s ease-out forwards; border-left: 6px solid; 
        }
        @keyframes floatUp { 0% { transform: translateY(30px); opacity: 0; } 10% { transform: translateY(0); opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-120px); opacity: 0; } }
        
        .mode-btn { border: 2px solid transparent; transition: all 0.2s; border-radius: 9999px; }
        .mode-btn.active { border-color: black; background: black !important; color: white !important; transform: scale(1.05); }
        
        .clear-btn { 
            background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            transition: all 0.2s; border: 2px solid #000; border-radius: 9999px; 
            font-weight: 900; font-size: 11px; letter-spacing: 0.05em; 
        }
        .clear-btn:hover { transform: translateY(-2px); background: #fff1f2; border-color: #ef4444; color: #ef4444; }
        
        .passcode-input { letter-spacing: 0.5em; text-align: center; font-weight: 900; border: 3px solid #e2e8f0; }
        .hidden-stage { display: none !important; }
    </style>
</head>
<body>

    <!-- Festive Login Overlay with Holi Theme -->
    <div id="login-overlay">
        <!-- Colored Clouds -->
        <div class="holi-bg-blob" style="background: #ff00ff; top: -10%; left: -10%;"></div>
        <div class="holi-bg-blob" style="background: #ffff00; top: 30%; left: 80%; animation-delay: -5s;"></div>
        <div class="holi-bg-blob" style="background: #00ffff; top: 60%; left: 0%; animation-delay: -10s;"></div>
        <div class="holi-bg-blob" style="background: #ff4500; top: 80%; left: 60%; animation-delay: -15s;"></div>
        
        <!-- Floating Holi Decorations -->
        <div class="floating-icon" style="left: 5%; animation-duration: 10s;">üî´</div>
        <div class="floating-icon" style="left: 15%; animation-duration: 15s; animation-delay: -2s;">ü™£</div>
        <div class="floating-icon" style="left: 30%; animation-duration: 13s; animation-delay: -5s;">üåà</div>
        <div class="floating-icon" style="left: 50%; animation-duration: 11s; animation-delay: -7s;">üé®</div>
        <div class="floating-icon" style="left: 70%; animation-duration: 16s; animation-delay: -1s;">üî´</div>
        <div class="floating-icon" style="left: 85%; animation-duration: 14s; animation-delay: -4s;">ü™£</div>
        <div class="floating-icon" style="left: 95%; animation-duration: 12s; animation-delay: -3s;">üåà</div>

        <div class="login-card p-12 rounded-[4rem] shadow-2xl w-full max-w-md text-center">
            <div class="mb-6 scale-110">
                <span class="text-7xl">üé®</span>
            </div>
            <h2 class="text-4xl font-black gradient-text uppercase tracking-tighter mb-1">Team Holi Portal</h2>
            <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em] mb-10">Bura Na Mano, Holi Hai! ‚ú®</p>
            
            <!-- Stage 1: Email -->
            <div id="login-stage-email">
                <p class="text-gray-600 text-sm mb-8 font-medium">Enter your work email to receive your secure passcode.</p>
                <form id="email-form" class="space-y-5">
                    <input type="email" id="user-email" required class="w-full px-6 py-5 bg-white border-2 border-gray-100 rounded-[2rem] outline-none focus:border-purple-500 font-bold text-center shadow-inner" placeholder="yourname@company.com">
                    <p id="email-error" class="text-red-500 text-[10px] font-black uppercase tracking-wider hidden">Email not found on Guest List.</p>
                    <div id="email-sending-status" class="text-purple-600 text-[10px] font-black hidden animate-pulse uppercase tracking-widest">Delivering secure code to inbox...</div>
                    <button type="submit" id="btn-get-passcode" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-black py-5 rounded-[2rem] shadow-2xl hover:opacity-90 active:scale-95 transition-all uppercase tracking-widest">Get Passcode</button>
                </form>
            </div>

            <!-- Stage 2: Passcode Verification -->
            <div id="login-stage-passcode" class="hidden-stage">
                <p class="text-gray-600 text-sm mb-5 font-medium">Verify the 6-digit code sent to:<br><span id="target-email-display" class="text-purple-600 font-black">...</span></p>
                <form id="passcode-form" class="space-y-5">
                    <input type="text" maxlength="6" id="user-passcode" required class="passcode-input w-full px-6 py-5 bg-white border-gray-200 rounded-[2rem] outline-none focus:border-green-500 text-3xl" placeholder="000000">
                    <p id="passcode-error" class="text-red-500 text-[10px] font-black uppercase tracking-wider hidden">Invalid code. Check your email again.</p>
                    <button type="submit" class="w-full bg-green-600 text-white font-black py-5 rounded-[2rem] shadow-2xl hover:bg-green-700 active:scale-95 transition-all uppercase tracking-widest text-sm">Verify & Login</button>
                    <button type="button" onclick="resetToEmail()" class="text-[10px] text-gray-400 font-black uppercase mt-4 hover:text-gray-600 transition flex items-center justify-center gap-2 w-full">‚Üê Use different email</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-overlay">
        <div class="bg-white p-8 rounded-[3rem] w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black">Authorized Guests</h3>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Admin Control Center</p>
                </div>
                <button onclick="toggleAdminPanel(false)" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-full transition">‚úï</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 overflow-y-auto">
                <div class="bg-gray-50 p-6 rounded-[2rem] border border-gray-100">
                    <h4 class="text-[10px] font-black mb-4 uppercase text-gray-400">Add Guest</h4>
                    <form id="admin-add-form" class="flex flex-col gap-3">
                        <input type="text" id="new-name" placeholder="Full Name" class="p-4 border rounded-2xl text-sm font-bold outline-none focus:border-blue-500" required>
                        <input type="email" id="new-email" placeholder="Work Email" class="p-4 border rounded-2xl text-sm font-bold outline-none focus:border-blue-500" required>
                        <select id="new-gender" class="p-3 border rounded-2xl text-sm font-bold">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <button type="submit" class="bg-blue-600 text-white p-4 rounded-2xl font-black text-xs hover:bg-blue-700">AUTHORIZE</button>
                    </form>
                </div>
                <div class="bg-indigo-50 p-6 rounded-[2rem] border border-indigo-100">
                    <h4 class="text-[10px] font-black mb-1 uppercase text-indigo-400">Bulk Import</h4>
                    <textarea id="bulk-import-text" class="w-full h-32 p-3 text-[11px] border rounded-2xl outline-none focus:border-indigo-400 font-mono" placeholder="John Doe, john@company.com, male"></textarea>
                    <button onclick="handleBulkImport()" class="w-full mt-3 bg-indigo-600 text-white py-4 rounded-2xl font-black text-xs hover:bg-indigo-700">IMPORT LIST</button>
                    <div id="import-status" class="text-[10px] font-black mt-2 text-center hidden"></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto space-y-2 pr-2 border-t pt-4 custom-scrollbar" id="employee-list-admin"></div>
        </div>
    </div>

    <canvas id="holiCanvas"></canvas>

    <div class="ui-layer">
        <div class="flex justify-between items-start">
            <div class="card interactive bg-white/90 backdrop-blur-md p-5 rounded-[2rem] shadow-xl border-b-4 border-purple-500 flex items-center gap-4">
                <div id="user-pfp" class="w-14 h-14 bg-gradient-to-tr from-purple-500 to-blue-600 rounded-full flex items-center justify-center text-white font-black text-2xl shadow-inner">?</div>
                <div>
                    <h1 id="display-name" class="font-black text-gray-800 leading-none text-xl tracking-tighter uppercase">Employee</h1>
                    <div class="flex gap-3 items-center mt-1.5">
                        <p class="text-[10px] font-black text-green-500 uppercase tracking-widest flex items-center gap-1.5"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ONLINE</p>
                        <button onclick="logout()" class="text-[10px] font-black text-red-500 uppercase hover:underline transition">Logout üö™</button>
                    </div>
                    <button id="admin-btn" onclick="toggleAdminPanel(true)" class="hidden mt-2.5 text-[9px] bg-red-100 text-red-600 font-black px-4 py-1.5 rounded-full uppercase tracking-widest hover:bg-red-200 transition">Admin Tools</button>
                </div>
            </div>

            <div class="flex flex-col gap-4 items-end">
                <div class="card interactive bg-white/95 backdrop-blur-lg p-6 rounded-[2.5rem] shadow-2xl w-80 border border-white">
                    <p class="text-[11px] font-black text-gray-400 mb-4 uppercase tracking-widest flex justify-between items-center">
                        Select Target <span id="recipient-count" class="bg-purple-100 text-purple-600 px-3 py-0.5 rounded-full text-[9px]">Everyone</span>
                    </p>
                    <div id="target-list" class="max-h-40 overflow-y-auto flex flex-col gap-2 border-b pb-4 mb-4 custom-scrollbar pr-1">
                        <label class="flex items-center gap-2.5 text-xs font-black cursor-pointer bg-purple-50 p-2.5 rounded-2xl border border-purple-100">
                            <input type="checkbox" id="select-all-targets" checked class="w-4 h-4 rounded text-purple-500"> Everyone üåà
                        </label>
                    </div>
                    <textarea id="wish-text" rows="2" placeholder="Send a Holi message..." class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl text-xs font-bold outline-none mb-4 resize-none focus:border-purple-300 transition"></textarea>
                    <button onclick="sendAction()" class="w-full py-4 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 text-white rounded-2xl font-black text-xs hover:opacity-90 shadow-xl uppercase tracking-wider active:scale-95 transition-all">Send Blast & Wish! ‚ú®</button>
                </div>
                
                <div class="flex gap-3">
                    <!-- ONLY CLEAR ALL BOARD BUTTON REMAINING -->
                    <button id="clear-all-btn" onclick="clearMyBoard()" class="interactive clear-btn px-8 py-3.5 text-red-500 flex items-center gap-3 active:scale-95">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                        CLEAR ALL BOARD
                    </button>
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-5 items-center justify-between interactive">
            <div class="bg-white/95 backdrop-blur-md p-4 rounded-[2.5rem] shadow-2xl flex gap-3 overflow-x-auto max-w-md no-scrollbar border border-white" id="palette"></div>
            <div class="flex flex-wrap gap-3 justify-center bg-black/90 p-4 rounded-[2.5rem] shadow-2xl">
                <button onclick="setMode('splash')" id="btn-splash" class="mode-btn active px-7 py-4 rounded-full font-black text-[11px] uppercase bg-gray-800 text-gray-400 transition-all">Splash</button>
                <button onclick="setMode('pichkari')" id="btn-pichkari" class="mode-btn px-7 py-4 rounded-full font-black text-[11px] uppercase bg-gray-800 text-gray-400 transition-all">Pichkari</button>
                <button onclick="setMode('blast')" id="btn-blast" class="mode-btn px-7 py-4 rounded-full font-black text-[11px] uppercase bg-gray-800 text-gray-400 transition-all">Blast</button>
                <button onclick="setMode('egg')" id="btn-egg" class="mode-btn px-7 py-4 rounded-full font-black text-[11px] uppercase bg-gray-800 text-gray-400 transition-all">Egg Blast</button>
                <button onclick="triggerMegaBlast()" class="px-5 py-4 rounded-full font-black bg-white text-black hover:scale-110 active:scale-95 transition-all uppercase tracking-widest text-[11px]">MEGA BLAST üí•</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, getDocs, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // FIREBASE CREDENTIALS
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { 
                apiKey: "AIzaSyAdMxwRFRffwyq6y2V5BywHqyU2_ykcfHo", 
                authDomain: "holi-86266.firebaseapp.com", 
                projectId: "holi-86266", 
                storageBucket: "holi-86266.firebasestorage.app", 
                messagingSenderId: "878132234023", 
                appId: "1:878132234023:web:d6d01419f44f621ed60b02" 
            };

        // EMAILJS CREDENTIALS
        const EMAILJS_SERVICE_ID = "service_ldrohn4";
        const EMAILJS_TEMPLATE_ID = "template_pvt74d4";
        const EMAILJS_PUBLIC_KEY = "RpZpsuRQYOT780rwI";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : "holi-bash-v8-final";
        const ADMIN_EMAIL = "prudhvireddy882@gmail.com";
        const HOLI_COLORS = ['#FF1493', '#FF4500', '#FFD700', '#32CD32', '#00BFFF', '#8A2BE2', '#FF6347', '#00FA9A', '#FFFF00', '#FF00FF', '#FFFACD', '#FFFFFF', '#00CED1'];

        const canvas = document.getElementById('holiCanvas');
        const ctx = canvas.getContext('2d');
        const targetListDiv = document.getElementById('target-list');
        const wishInput = document.getElementById('wish-text');
        
        let particles = [];
        let interactionMode = 'splash';
        let isDrawing = false;
        let currentColor = '#FF1493';
        let currentUser = null;
        let employees = [];
        let activeActivities = [];
        let pendingUser = null;

        if (typeof emailjs !== 'undefined') emailjs.init(EMAILJS_PUBLIC_KEY);

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                } else { await signInAnonymously(auth); }
            } catch (err) { await signInAnonymously(auth); }
        };
        initAuth();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const empCol = collection(db, 'artifacts', APP_ID, 'public', 'data', 'employees');
                onSnapshot(empCol, (snapshot) => {
                    employees = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    updateTargetUI();
                    updateAdminList();
                });
            }
        });

        document.getElementById('email-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('user-email').value.toLowerCase().trim();
            const found = employees.find(emp => emp.email === email) || (email === ADMIN_EMAIL ? { name: "Prudhvi (Admin)", email: ADMIN_EMAIL, gender: "male" } : null);

            if (found) {
                pendingUser = found;
                const statusEl = document.getElementById('email-sending-status');
                statusEl.classList.remove('hidden');
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                const id = email.replace(/[^a-zA-Z0-9]/g, '_');
                
                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'employees', id), { 
                        ...found, currentPasscode: code, lastPasscodeAt: serverTimestamp() 
                    }, { merge: true });
                    
                    if (typeof emailjs !== 'undefined') {
                        // UPDATED: 'email' matches your "To Email" setting, 'message' matches template placeholder
                        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                            email: email, 
                            name: found.name, 
                            message: code
                        });
                    }
                    
                    statusEl.classList.add('hidden');
                    document.getElementById('target-email-display').innerText = email;
                    document.getElementById('login-stage-email').classList.add('hidden-stage');
                    document.getElementById('login-stage-passcode').classList.remove('hidden-stage');
                } catch (err) { statusEl.classList.add('hidden'); alert("Email service error. Check IDs."); }
            } else { document.getElementById('email-error').classList.remove('hidden'); }
        };

        document.getElementById('passcode-form').onsubmit = async (e) => {
            e.preventDefault();
            const entered = document.getElementById('user-passcode').value;
            const userInList = employees.find(emp => emp.email === pendingUser.email);
            if ((userInList && userInList.currentPasscode === entered) || (pendingUser.email === ADMIN_EMAIL && entered === "123456")) {
                loginSuccess(userInList || pendingUser);
            } else { document.getElementById('passcode-error').classList.remove('hidden'); }
        };

        function loginSuccess(found) {
            currentUser = found;
            document.getElementById('display-name').innerText = found.name;
            document.getElementById('user-pfp').innerText = found.name[0];
            if (found.email === ADMIN_EMAIL) document.getElementById('admin-btn').classList.remove('hidden');
            document.getElementById('login-overlay').style.display = 'none';
            initCanvas();
            startListeningToActivities();
        }

        window.logout = async () => { await signOut(auth); window.location.reload(); };
        window.resetToEmail = () => {
            document.getElementById('login-stage-passcode').classList.add('hidden-stage');
            document.getElementById('login-stage-email').classList.remove('hidden-stage');
        };

        function startListeningToActivities() {
            if (!currentUser || !auth.currentUser) return;
            const activityCol = collection(db, 'artifacts', APP_ID, 'public', 'data', 'activities');
            
            let isInitialLoad = true;
            onSnapshot(activityCol, (snapshot) => {
                const incoming = snapshot.docs
                    .map(d => ({id: d.id, ...d.data()}))
                    .filter(d => d.toEmail === currentUser.email || d.toEmail === 'Everyone');
                
                if (isInitialLoad) {
                    activeActivities = incoming;
                    isInitialLoad = false;
                    clearAndRedraw();
                    return;
                }

                // If deletions happen (Clear All), reload the board
                if (incoming.length < activeActivities.length) {
                    activeActivities = incoming;
                    clearAndRedraw();
                    return;
                }

                // Only play animations for truly NEW records to prevent flickering
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        if (data.toEmail === currentUser.email || data.toEmail === 'Everyone') {
                            renderActivity(data);
                            activeActivities.push({id: change.doc.id, ...data});
                        }
                    }
                });
            });
        }

        function renderActivity(data) {
            if (data.type === 'mega-blast') {
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        const rc = HOLI_COLORS[Math.floor(Math.random() * HOLI_COLORS.length)];
                        createSplashEffect(x, y, rc, 85, 'blast');
                    }, i * 110);
                }
                return;
            }
            const x = data.x || Math.random() * canvas.width;
            const y = data.y || Math.random() * canvas.height;
            if (data.type === 'wish') showWishPopup(data.fromName, data.wishText, data.color);
            if (data.type === 'blast') {
                for(let j=0; j<4; j++) {
                    const rc = HOLI_COLORS[Math.floor(Math.random() * HOLI_COLORS.length)];
                    createSplashEffect(x, y, rc, 35, 'blast');
                }
            } else {
                createSplashEffect(x, y, data.color, (data.type === 'egg' ? 80 : 40), data.type);
            }
        }

        function showWishPopup(from, text, color) {
            const div = document.createElement('div');
            div.className = 'wish-popup';
            div.style.borderColor = color;
            div.style.left = (Math.random() * 50 + 20) + '%';
            div.style.top = (Math.random() * 50 + 20) + '%';
            div.innerHTML = `<div class="text-[10px] font-black uppercase text-gray-400">Wish from ${from}</div><div class="text-sm font-bold mt-1 text-gray-800">${text}</div>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 6000);
        }

        function clearAndRedraw() {
            ctx.fillStyle = '#fdfdfd';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            particles = []; // Stop active animations
        }

        window.triggerMegaBlast = async () => {
            if (!currentUser || !auth.currentUser) return;
            const targets = document.getElementById('select-all-targets').checked ? ['Everyone'] : Array.from(document.querySelectorAll('.target-checkbox:checked')).map(cb => cb.value);
            for (const t of targets) {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'activities'), {
                    fromName: currentUser.name, fromEmail: currentUser.email, toEmail: t, type: 'mega-blast', color: currentColor, timestamp: serverTimestamp()
                });
            }
        };

        window.sendAction = async () => {
            if (!currentUser || !auth.currentUser) return;
            const wish = wishInput.value.trim() || "Bura na mano, Holi hai! üåà‚ú®";
            const targets = document.getElementById('select-all-targets').checked ? ['Everyone'] : Array.from(document.querySelectorAll('.target-checkbox:checked')).map(cb => cb.value);
            for (const t of targets) {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'activities'), {
                    fromName: currentUser.name, fromEmail: currentUser.email, toEmail: t, type: interactionMode === 'splash' ? 'wish' : interactionMode,
                    wishText: wish, color: currentColor, x: Math.random() * canvas.width, y: Math.random() * canvas.height, timestamp: serverTimestamp()
                });
            }
            wishInput.value = "";
        };

        // NEW ROBUST CLEAR ALL LOGIC
        window.clearMyBoard = async () => {
            if (!currentUser || !auth.currentUser) return;
            const btn = document.getElementById('clear-all-btn');
            const original = btn.innerHTML;
            btn.innerText = "CLEARING...";
            btn.disabled = true;

            try {
                const col = collection(db, 'artifacts', APP_ID, 'public', 'data', 'activities');
                const snapshot = await getDocs(col);
                const deletePromises = [];
                snapshot.docs.forEach(d => {
                    const data = d.data();
                    if (data.toEmail === currentUser.email || data.toEmail === 'Everyone') {
                        deletePromises.push(deleteDoc(d.ref));
                    }
                });
                if (deletePromises.length > 0) await Promise.all(deletePromises);
                clearAndRedraw();
            } catch (err) { console.error(err); } finally { btn.innerHTML = original; btn.disabled = false; }
        };

        window.handleBulkImport = async () => {
            const ta = document.getElementById('bulk-import-text');
            const lines = ta.value.trim().split('\n');
            let count = 0;
            for (let line of lines) {
                const p = line.split(/[,\t]/).map(s => s.trim());
                if (p.length >= 2) {
                    const id = p[1].toLowerCase().replace(/[^a-zA-Z0-9]/g, '_');
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'employees', id), { name: p[0], email: p[1].toLowerCase(), gender: p[2] || 'male' });
                    count++;
                }
            }
            ta.value = "";
            document.getElementById('import-status').innerText = `ADDED ${count} MEMBERS.`;
            document.getElementById('import-status').classList.remove('hidden');
        };

        document.getElementById('admin-add-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('new-email').value.toLowerCase();
            const id = email.replace(/[^a-zA-Z0-9]/g, '_');
            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'employees', id), { name: document.getElementById('new-name').value, email: email, gender: document.getElementById('new-gender').value });
            e.target.reset();
        };

        window.deleteEmployee = async (id) => await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'employees', id));

        function updateAdminList() {
            document.getElementById('employee-list-admin').innerHTML = employees.map(emp => `
                <div class="flex justify-between items-center p-4 bg-white border border-gray-100 rounded-2xl shadow-sm text-[11px] font-black uppercase">
                    <div>${emp.name} <span class="text-[9px] text-gray-400 lowercase font-bold">(${emp.email})</span></div>
                    <button onclick="deleteEmployee('${emp.id}')" class="text-red-500 hover:bg-red-50 px-4 py-1 rounded-xl transition">Remove</button>
                </div>
            `).join('');
        }

        function updateTargetUI() {
            const selectAll = document.getElementById('select-all-targets')?.checked;
            targetListDiv.innerHTML = `<label class="flex items-center gap-3 text-xs font-black cursor-pointer bg-purple-50 p-2.5 rounded-2xl border border-purple-100"><input type="checkbox" id="select-all-targets" ${selectAll ? 'checked' : ''}> Everyone üåà</label>`;
            employees.forEach(emp => {
                if (currentUser && emp.email === currentUser.email) return;
                const div = document.createElement('label');
                div.className = "flex items-center gap-3 text-[11px] font-bold py-2.5 border-b border-gray-50 hover:bg-gray-50 transition px-2";
                div.innerHTML = `<input type="checkbox" class="target-checkbox" value="${emp.email}"> ${emp.name}`;
                targetListDiv.appendChild(div);
            });
        }

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.fillStyle = '#fdfdfd';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const palette = document.getElementById('palette');
            palette.innerHTML = '';
            HOLI_COLORS.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-swatch flex-shrink-0 ${color === currentColor ? 'active-color' : ''}`;
                div.style.backgroundColor = color;
                div.onclick = () => { currentColor = color; document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active-color')); div.classList.add('active-color'); };
                palette.appendChild(div);
            });
            animate();
        }

        class Particle {
            constructor(x, y, color, size, vx, vy, type) {
                this.x = x; this.y = y; this.color = color; this.size = size;
                this.vx = vx; this.vy = vy; this.alpha = 1;
                this.decay = type === 'egg' ? 0.005 : 0.012;
                this.gravity = type === 'pichkari' ? 0.04 : 0.12;
            }
            draw() { ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); ctx.restore(); }
            update() { 
                this.x += this.vx; this.y += this.vy; this.vy += this.gravity; this.alpha -= this.decay; 
                if (this.alpha <= 0.05) { ctx.save(); ctx.globalAlpha = 0.2; ctx.beginPath(); ctx.arc(this.x, this.y, this.size * 2.2, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); ctx.restore(); } 
            }
        }

        function createSplashEffect(x, y, color, density, type) {
            let fc = (type === 'egg') ? (Math.random() > 0.5 ? '#FFFACD' : '#FFFFFF') : color;
            for (let i = 0; i < density; i++) {
                const s = Math.random() * (type === 'egg' ? 14 : 9) + 2;
                const a = Math.random() * Math.PI * 2;
                const sp = Math.random() * (type === 'blast' ? 15 : 10) + 2;
                particles.push(new Particle(x, y, fc, s, Math.cos(a)*sp, Math.sin(a)*sp-2, type));
            }
            document.body.classList.add('vibrate'); setTimeout(() => document.body.classList.remove('vibrate'), 120);
        }

        function animate() { 
            particles.forEach((p, i) => { p.update(); p.draw(); if (p.alpha <= 0) particles.splice(i, 1); }); 
            requestAnimationFrame(animate); 
        }

        window.setMode = (m) => { interactionMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-' + m).classList.add('active'); };
        window.toggleAdminPanel = (s) => document.getElementById('admin-overlay').style.display = s ? 'flex' : 'none';
        
        window.onmousemove = (e) => {
            if (!currentUser) return;
            if (isDrawing && interactionMode === 'pichkari') { createSplashEffect(e.clientX, e.clientY, currentColor, 4, 'pichkari'); }
        };

        window.onmousedown = (e) => { 
            if (e.target.tagName === 'CANVAS') { 
                isDrawing = true; 
                if (interactionMode !== 'pichkari') {
                    if (interactionMode === 'blast') {
                        for(let j=0; j<4; j++) {
                            const rc = HOLI_COLORS[Math.floor(Math.random() * HOLI_COLORS.length)];
                            createSplashEffect(e.clientX, e.clientY, rc, 35, 'blast');
                        }
                    } else {
                        createSplashEffect(e.clientX, e.clientY, currentColor, 45, interactionMode);
                    }
                }
            } 
        };
        window.onmouseup = () => isDrawing = false;
        window.onresize = initCanvas;
    </script>
</body>
</html>
